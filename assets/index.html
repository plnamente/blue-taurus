<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue-Taurus | Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { fontFamily: { sans: ['Inter', 'sans-serif'] }, extend: { colors: { slate: { 850: '#151e2e', 900: '#0f172a' } } } } }
    </script>
    <style>
        body { background-color: #0b1120; color: #cbd5e1; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .tab-btn.active { border-bottom: 2px solid #3b82f6; color: #60a5fa; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- SIDEBAR COMPLETA (RESTAURADA) -->
    <aside class="w-64 bg-slate-850 border-r border-slate-700 flex flex-col z-30">
        <div class="h-16 flex items-center px-6 border-b border-slate-700/50">
            <i class="ph-fill ph-shield-check text-blue-500 text-2xl mr-2"></i>
            <h1 class="font-bold text-lg text-white tracking-tight">BLUE-TAURUS</h1>
        </div>
        <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
            <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 mt-2">Vis&atilde;o Geral</p>
            <a href="#" class="nav-item flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-white bg-slate-800 rounded-lg">
                <i class="ph ph-chart-pie-slice text-lg"></i> Data Analytics
            </a>
            <a href="#" class="nav-item flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:text-white transition-colors">
                <i class="ph ph-desktop text-lg"></i> Invent&aacute;rio
            </a>
            
            <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 mt-6">Seguran&ccedil;a</p>
            <a href="#" class="nav-item flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:text-white transition-colors">
                <i class="ph ph-check-circle text-lg"></i> Compliance CIS
            </a>
            <a href="#" class="nav-item flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:text-white transition-colors">
                <i class="ph ph-warning-octagon text-lg"></i> Vulnerabilidades
            </a>
        </nav>
    </aside>

    <!-- AREA PRINCIPAL -->
    <main class="flex-1 flex flex-col overflow-hidden relative bg-[#0b1120]">
        <header class="h-16 flex items-center justify-between px-8 border-b border-slate-700/50 bg-slate-900/50 backdrop-blur-sm">
            <h2 class="text-lg font-semibold text-white">Data Analytics Dashboard</h2>
            <div class="flex items-center gap-4">
                <span class="flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-slate-700 text-xs text-slate-400">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Sistema Online
                </span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 scroll-smooth">
            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="card p-6 border-l-4 border-blue-500"><p class="text-slate-400 text-xs uppercase font-bold">Total Ativos</p><h3 id="kpi-total" class="text-3xl font-bold text-white mt-2">--</h3></div>
                <div class="card p-6 border-l-4 border-emerald-500">
                    <p class="text-slate-400 text-xs uppercase font-bold">Compliance Score</p>
                    <h3 id="kpi-score" class="text-3xl font-bold text-emerald-400 mt-2">--%</h3>
                    <p class="text-xs text-slate-500 mt-1">M&eacute;dia da Rede (CIS v8)</p>
                </div>
                <div class="card p-6 border-l-4 border-amber-500"><p class="text-slate-400 text-xs uppercase font-bold">Riscos Altos</p><h3 class="text-3xl font-bold text-white mt-2">--</h3></div>
                <div class="card p-6 border-l-4 border-purple-500"><p class="text-slate-400 text-xs uppercase font-bold">Eventos (24h)</p><h3 class="text-3xl font-bold text-white mt-2">--</h3></div>
            </div>

            <!-- INVENTORY TABLE -->
            <div class="card overflow-hidden">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                    <h2 class="text-sm font-bold text-white flex items-center gap-2"><i class="ph-duotone ph-list-dashes text-lg text-blue-400"></i> Invent&aacute;rio de M&aacute;quinas</h2>
                    <button onclick="fetchAgents()" class="text-slate-400 hover:text-white"><i class="ph-bold ph-arrows-clockwise text-xl"></i></button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-800/80 text-slate-400 font-semibold uppercase tracking-wider">
                            <tr>
                                <th class="p-3">Ativo / Hostname</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Sistema</th>
                                <th class="p-3 text-center">Score CIS</th>
                                <th class="p-3">&Uacute;ltimo Visto</th>
                                <th class="p-3 text-right">A&ccedil;&atilde;o</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-700/50 text-slate-300"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL DETALHES (COM 3 ABAS) -->
    <div id="details-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-black opacity-60 backdrop-blur-sm"></div>
        <div class="modal-container bg-slate-800 w-11/12 md:max-w-4xl mx-auto rounded-xl shadow-2xl z-50 overflow-hidden border border-slate-700 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                <div>
                    <h3 class="text-xl font-bold text-white" id="modal-hostname">Host</h3>
                    <p class="text-xs text-slate-400 font-mono mt-1" id="modal-id">UUID</p>
                </div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white bg-slate-800 p-2 rounded-lg"><i class="ph-bold ph-x"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto">
                <!-- TABS -->
                <div class="flex gap-4 border-b border-slate-700 mb-4">
                    <button id="tab-hw" onclick="switchTab('hw')" class="tab-btn active px-4 py-2 text-sm font-medium text-slate-400 hover:text-white transition-colors">Hardware</button>
                    <button id="tab-sw" onclick="switchTab('sw')" class="tab-btn px-4 py-2 text-sm font-medium text-slate-400 hover:text-white transition-colors">Software</button>
                    <button id="tab-cis" onclick="switchTab('cis')" class="tab-btn px-4 py-2 text-sm font-medium text-slate-400 hover:text-white transition-colors">Seguran&ccedil;a (CIS)</button>
                </div>

                <!-- TAB CONTENT: HARDWARE -->
                <div id="content-hw" class="block space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-slate-700/30 p-4 rounded-lg border border-slate-600/50"><p class="text-xs text-slate-400 uppercase font-bold">CPU</p><p class="text-white text-sm mt-1" id="modal-cpu">-</p></div>
                        <div class="bg-slate-700/30 p-4 rounded-lg border border-slate-600/50"><p class="text-xs text-slate-400 uppercase font-bold">N&uacute;cleos</p><p class="text-white text-sm mt-1" id="modal-cores">-</p></div>
                        <div class="bg-slate-700/30 p-4 rounded-lg border border-slate-600/50"><p class="text-xs text-slate-400 uppercase font-bold">RAM</p><p class="text-white text-sm mt-1" id="modal-ram">-</p></div>
                        <div class="bg-slate-700/30 p-4 rounded-lg border border-slate-600/50"><p class="text-xs text-slate-400 uppercase font-bold">Disco</p><p class="text-white text-sm mt-1" id="modal-disk">-</p></div>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-slate-300 mb-2">Perif&eacute;ricos USB Detectados (Via PowerShell)</h4>
                        <div class="bg-slate-900 rounded p-3 text-xs font-mono text-slate-400 border border-slate-700" id="modal-usb-list">
                            Nenhum perif&eacute;rico listado no banco.
                        </div>
                    </div>
                </div>

                <!-- TAB CONTENT: SOFTWARE -->
                <div id="content-sw" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-900 text-slate-400"><tr><th class="p-2">Nome</th><th class="p-2">Vers&atilde;o</th><th class="p-2">Vendor</th></tr></thead>
                            <tbody id="modal-sw-body" class="divide-y divide-slate-700 text-slate-300"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB CONTENT: COMPLIANCE -->
                <div id="content-cis" class="hidden">
                    <div class="mb-4 p-4 bg-slate-900 rounded-lg border border-slate-700 flex justify-between items-center">
                        <div>
                            <span class="text-sm text-slate-400 block">Status da Auditoria</span>
                            <span class="font-bold text-lg text-white" id="modal-score-explain">--</span>
                        </div>
                        <span class="font-mono text-xs text-blue-400 bg-blue-500/10 px-2 py-1 rounded" id="modal-policy-name">--</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-900 text-slate-400"><tr><th class="p-2 w-10">Status</th><th class="p-2">Regra</th><th class="p-2">Output</th></tr></thead>
                            <tbody id="modal-cis-body" class="divide-y divide-slate-700 text-slate-300"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/agents';
        let uniqueAgents = [];

        async function fetchAgents() {
            try {
                const res = await fetch(API_URL);
                const agents = await res.json();
                const map = new Map();
                agents.forEach(a => {
                    const exist = map.get(a.hostname);
                    const curr = new Date(a.last_seen_at || 0);
                    if(!exist || curr > new Date(exist.last_seen_at || 0)) map.set(a.hostname, a);
                });
                uniqueAgents = Array.from(map.values());
                renderTable();
                renderKPIs();
            } catch(e) { console.error(e); }
        }

        function renderKPIs() {
            document.getElementById('kpi-total').innerText = uniqueAgents.length;
            let totalScore = 0, scoredAgents = 0;
            uniqueAgents.forEach(a => {
                if (a.compliance_score !== null && a.compliance_score !== undefined) {
                    totalScore += a.compliance_score;
                    scoredAgents++;
                }
            });
            const avgScore = scoredAgents > 0 ? Math.round(totalScore / scoredAgents) : 0;
            document.getElementById('kpi-score').innerText = avgScore + '%';
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            uniqueAgents.forEach(agent => {
                const lastSeen = agent.last_seen_at ? new Date(agent.last_seen_at).toLocaleString() : 'N/A';
                const statusBadge = agent.status === 'ONLINE' ? '<span class="text-emerald-400 font-bold">&#9679; ON</span>' : '<span class="text-slate-500 font-bold">&#9679; OFF</span>';
                const iconClass = agent.os_name.toLowerCase().includes('windows') ? 'ph-windows-logo' : 'ph-linux-logo';
                
                let scoreHtml = '<span class="text-slate-600">-</span>';
                if(agent.compliance_score !== null) {
                    let color = 'text-red-400 border-red-500/30 bg-red-500/10';
                    if(agent.compliance_score >= 80) color = 'text-emerald-400 border-emerald-500/30 bg-emerald-500/10';
                    else if(agent.compliance_score >= 50) color = 'text-amber-400 border-amber-500/30 bg-amber-500/10';
                    scoreHtml = `<span class="px-2 py-1 rounded border ${color} font-bold text-xs">${agent.compliance_score}%</span>`;
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-800/50 transition-colors border-b border-slate-700/50';
                row.innerHTML = `
                    <td class="p-3 font-medium text-white flex items-center gap-2">
                        <div class="w-8 h-8 rounded bg-slate-700 flex items-center justify-center text-slate-300"><i class="ph-fill ${iconClass} text-lg"></i></div>
                        <div><div>${agent.hostname}</div><div class="text-[10px] text-slate-500 font-mono">${agent.id.substring(0,8)}...</div></div>
                    </td>
                    <td class="p-3 text-[10px]">${statusBadge}</td>
                    <td class="p-3 text-slate-400">${agent.os_name}</td>
                    <td class="p-3 text-center">${scoreHtml}</td>
                    <td class="p-3 text-slate-500">${lastSeen}</td>
                    <td class="p-3 text-right"><button onclick="openDetails('${agent.id}')" class="text-blue-400 hover:text-white text-xs font-bold border border-blue-500/30 px-3 py-1 rounded">Ver</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function openDetails(id) {
            const modal = document.getElementById('details-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('modal-hostname').innerText = "Carregando...";
            
            try {
                const res = await fetch('/api/agents/' + id + '/details');
                const data = await res.json();
                if(data) {
                    document.getElementById('modal-hostname').innerText = data.agent.hostname;
                    document.getElementById('modal-id').innerText = data.agent.id;
                    
                    // Hardware Tab
                    const hw = data.hardware || {};
                    document.getElementById('modal-cpu').innerText = hw.cpu_model || 'N/A';
                    document.getElementById('modal-cores').innerText = hw.cpu_cores || '-';
                    document.getElementById('modal-ram').innerText = (hw.ram_total_mb ? (hw.ram_total_mb/1024).toFixed(1) + ' GB' : 'N/A');
                    document.getElementById('modal-disk').innerText = (hw.disk_total_gb ? hw.disk_total_gb + ' GB' : 'N/A');
                    
                    // Software Tab
                    const swBody = document.getElementById('modal-sw-body');
                    swBody.innerHTML = '';
                    data.software.forEach(s => {
                        swBody.innerHTML += `<tr class="border-b border-slate-700/50"><td class="p-2 text-white">${s.name}</td><td class="p-2 text-slate-400">${s.version||'-'}</td><td class="p-2 text-slate-500">${s.vendor||'-'}</td></tr>`;
                    });

                    // Compliance Tab
                    const cisBody = document.getElementById('modal-cis-body');
                    cisBody.innerHTML = '';
                    if(data.compliance && data.compliance.details) {
                        document.getElementById('modal-policy-name').innerText = data.compliance.policy_id || 'Unknown Policy';
                        
                        // Score Explanation
                        const passed = data.compliance.passed_checks || 0;
                        const total = data.compliance.total_checks || 0;
                        const pct = data.compliance.score || 0;
                        let colorText = 'text-red-400';
                        if(pct >= 50) colorText = 'text-amber-400';
                        if(pct >= 80) colorText = 'text-emerald-400';
                        
                        document.getElementById('modal-score-explain').innerHTML = `<span class="${colorText}">${pct}% Aprovado</span> <span class="text-xs text-slate-500 font-normal ml-2">(${passed} de ${total} regras)</span>`;

                        data.compliance.details.forEach(rule => {
                            const statusBadge = rule.status === 'PASS' 
                                ? '<span class="bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded text-[10px] font-bold border border-emerald-500/30">PASS</span>'
                                : '<span class="bg-red-500/20 text-red-400 px-2 py-0.5 rounded text-[10px] font-bold border border-red-500/30">FAIL</span>';
                            
                            cisBody.innerHTML += `
                                <tr class="border-b border-slate-700/50 hover:bg-slate-800/30">
                                    <td class="p-3">${statusBadge}</td>
                                    <td class="p-3 text-white font-medium text-xs">
                                        ${rule.title}
                                        <div class="text-[10px] text-slate-500 font-mono mt-0.5">ID: ${rule.rule_id}</div>
                                    </td>
                                    <td class="p-3 text-[10px] text-slate-400 font-mono break-all max-w-xs">${rule.output}</td>
                                </tr>`;
                        });
                    } else {
                        cisBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-500">Nenhum dado de auditoria dispon&iacute;vel.</td></tr>';
                    }
                }
            } catch(e) {}
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            
            document.getElementById('content-hw').classList.add('hidden');
            document.getElementById('content-sw').classList.add('hidden');
            document.getElementById('content-cis').classList.add('hidden');
            document.getElementById('content-' + tab).classList.remove('hidden');
        }

        function closeModal() { document.getElementById('details-modal').classList.add('opacity-0', 'pointer-events-none'); }
        document.querySelector('.modal-overlay').addEventListener('click', closeModal);

        fetchAgents();
        setInterval(fetchAgents, 5000);
    </script>
</body>
</html>